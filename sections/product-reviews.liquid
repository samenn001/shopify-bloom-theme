{{ 'section-product-reviews.css' | asset_url | stylesheet_tag }}

{% liquid
  assign should_show = true
  if section.settings.restrict_visibility
    assign should_show = false
    if section.settings.only_collection_handle != blank and product
      for c in product.collections
        if c.handle == section.settings.only_collection_handle
          assign should_show = true
        endif
      endfor
    endif
    if section.settings.only_product_type != blank and product
      assign ptype = product.product_type
      if ptype == blank
        assign ptype = product.type
      endif
      assign ptype_lc = ptype | downcase
      assign want_type_lc = section.settings.only_product_type | downcase | strip
      if ptype_lc == want_type_lc
        assign should_show = true
      endif
    endif
    if section.settings.only_tag != blank and product
      if product.tags contains section.settings.only_tag
        assign should_show = true
      endif
    endif
    if section.settings.only_handles != blank and product
      assign product_handle_lc = product.handle | downcase
      assign allowed_handles = section.settings.only_handles | downcase | split: ','
      for h in allowed_handles
        assign h_trim = h | strip
        if h_trim == product_handle_lc
          assign should_show = true
        endif
      endfor
    endif
    if section.settings.only_product_ids != blank and product
      assign product_id_str = product.id | string
      assign allowed_ids = section.settings.only_product_ids | split: ','
      for idstr in allowed_ids
        assign id_trim = idstr | strip
        if id_trim == product_id_str
          assign should_show = true
        endif
      endfor
    endif
  endif
%}

{% if should_show %}

<div class="product-reviews-section">
  <div class="page-width">
    <div class="reviews-header">
      <h2 class="reviews-title">{{ section.settings.title }}</h2>
      <div class="reviews-summary">
        <div class="stars-rating">
          {% for i in (1..5) %}
            <svg class="star-icon" width="18" height="18" viewBox="0 0 24 24" fill="currentColor">
              <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
            </svg>
          {% endfor %}
        </div>
        <span class="review-count">{{ section.settings.review_count }} Reviews</span>
      </div>
    </div>

    <div class="reviews-grid">
      {% for block in section.blocks %}
        {% case block.type %}
          {% when 'review' %}
            <div class="review-card {% if block.settings.has_video %}has-video{% endif %}" {{ block.shopify_attributes }}>
              {% if block.settings.has_video %}
                <div class="review-video-wrapper">
                  <video 
                    class="review-video"
                    controls
                    playsinline
                    muted
                    preload="metadata"
                  >
                    <source src="{{ block.settings.video_url }}#t=0.1" type="video/mp4">
                  </video>
                  <div class="video-play-overlay">
                    <svg class="play-icon" width="28" height="28" viewBox="0 0 24 24" fill="currentColor">
                      <path d="M8 5v14l11-7z"/>
                    </svg>
                  </div>
                </div>
              {% endif %}
              
              <div class="review-content">
                <div class="review-rating">
                  <div class="review-stars">
                    {% for i in (1..5) %}
                      <svg class="star-icon {% if i <= block.settings.rating %}filled{% endif %}" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
                      </svg>
                    {% endfor %}
                  </div>
                  <span class="rating-number">{{ block.settings.rating }}.0</span>
                </div>
                
                {% if block.settings.product_variant %}
                  <div class="review-variant">{{ block.settings.product_variant }}</div>
                {% endif %}
                
                <p class="review-text">{{ block.settings.review_text }}</p>
                
                <div class="reviewer-footer">
                  <div class="reviewer-info">
                    <h4 class="reviewer-name">— {{ block.settings.reviewer_name }}</h4>
                    <div class="review-meta">
                      {% if block.settings.verified_purchase %}
                        <span class="verified-badge">
                          <svg viewBox="0 0 24 24" fill="currentColor">
                            <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
                          </svg>
                          Verified
                        </span>
                        <span>•</span>
                      {% endif %}
                      <span class="review-date">{{ block.settings.review_date }}</span>
                    </div>
                  </div>
                  
                  {% if block.settings.show_helpful %}
                    <div class="review-actions">
                      <button class="helpful-btn" aria-label="Mark as helpful">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                          <path d="M14 9V5a3 3 0 0 0-3-3l-4 9v11h11.28a2 2 0 0 0 2-1.7l1.38-9a2 2 0 0 0-2-2.3zM7 22H4a2 2 0 0 1-2-2v-7a2 2 0 0 1 2-2h3"/>
                        </svg>
                        Helpful
                      </button>
                    </div>
                  {% endif %}
                </div>
              </div>
            </div>
        {% endcase %}
      {% endfor %}
    </div>

    {% if section.settings.show_load_more %}
      <div class="reviews-footer">
        <button class="load-more-btn">Load More Reviews</button>
      </div>
    {% endif %}
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    const videoWrappers = document.querySelectorAll('.review-video-wrapper');
    
    videoWrappers.forEach(wrapper => {
      const video = wrapper.querySelector('.review-video');
      const overlay = wrapper.querySelector('.video-play-overlay');
      
      if (video && overlay) {
        // Hide controls initially
        video.controls = false;
        
        // Play video on overlay click
        overlay.addEventListener('click', (e) => {
          e.preventDefault();
          video.controls = true;
          video.play();
          overlay.style.opacity = '0';
          overlay.style.pointerEvents = 'none';
        });
        
        // Show overlay when video ends or is paused
        video.addEventListener('pause', () => {
          if (video.currentTime < video.duration) {
            overlay.style.opacity = '1';
            overlay.style.pointerEvents = 'auto';
            video.controls = false;
          }
        });
        
        video.addEventListener('ended', () => {
          overlay.style.opacity = '1';
          overlay.style.pointerEvents = 'auto';
          video.controls = false;
          video.currentTime = 0;
        });
      }
    });
    
    // Helpful button interaction
    document.querySelectorAll('.helpful-btn').forEach(btn => {
      btn.addEventListener('click', function() {
        this.style.color = '#000';
        this.innerHTML = '<svg viewBox="0 0 24 24" fill="currentColor" stroke="none"><path d="M14 9V5a3 3 0 0 0-3-3l-4 9v11h11.28a2 2 0 0 0 2-1.7l1.38-9a2 2 0 0 0-2-2.3zM7 22H4a2 2 0 0 1-2-2v-7a2 2 0 0 1 2-2h3"/></svg>Thanks!';
      });
    });
  });
</script>

{% endif %}

{% schema %}
{
  "name": "Product Reviews",
  "settings": [
    {
      "type": "text",
      "id": "title",
      "label": "Section Title",
      "default": "Customer Reviews"
    },
    {
      "type": "checkbox",
      "id": "restrict_visibility",
      "label": "Restrict to specific products",
      "default": true
    },
    {
      "type": "text",
      "id": "only_collection_handle",
      "label": "Only show for collection handle",
      "default": "interactive-toys",
      "info": "Example: interactive-toys. Leave blank to ignore this filter."
    },
    {
      "type": "text",
      "id": "only_product_type",
      "label": "Only show for product type",
      "default": "Interactive Toys",
      "info": "Matches the Product type field exactly (case-insensitive)."
    },
    {
      "type": "text",
      "id": "only_tag",
      "label": "Only show for product tag",
      "info": "Example: interactive-toy. Leave blank to ignore this filter."
    },
    {
      "type": "textarea",
      "id": "only_handles",
      "label": "Only show for product handles (comma-separated)",
      "info": "Example: interactive-cat-toy, smart-feather-wand",
      "default": "interactive-cat-toy"
    },
    {
      "type": "textarea",
      "id": "only_product_ids",
      "label": "Only show for product IDs (comma-separated)",
      "info": "Find the numeric product ID in Admin → Products (URL contains /products/ID)"
    },
    {
      "type": "text",
      "id": "review_count",
      "label": "Total Review Count",
      "default": "126"
    },
    {
      "type": "checkbox",
      "id": "show_load_more",
      "label": "Show Load More Button",
      "default": true
    }
  ],
  "blocks": [
    {
      "type": "review",
      "name": "Customer Review",
      "settings": [
        {
          "type": "text",
          "id": "reviewer_name",
          "label": "Reviewer Name",
          "default": "Customer Name"
        },
        {
          "type": "range",
          "id": "rating",
          "label": "Rating",
          "min": 1,
          "max": 5,
          "step": 1,
          "default": 5
        },
        {
          "type": "text",
          "id": "review_date",
          "label": "Review Date",
          "default": "2 days ago"
        },
        {
          "type": "text",
          "id": "product_variant",
          "label": "Product Variant",
          "default": "Blue Black"
        },
        {
          "type": "textarea",
          "id": "review_text",
          "label": "Review Text",
          "default": "Amazing product! My cats absolutely love it."
        },
        {
          "type": "checkbox",
          "id": "verified_purchase",
          "label": "Verified Purchase",
          "default": true
        },
        {
          "type": "checkbox",
          "id": "has_video",
          "label": "Has Video",
          "default": false
        },
        {
          "type": "url",
          "id": "video_url",
          "label": "Video URL"
        },
        {
          "type": "checkbox",
          "id": "show_helpful",
          "label": "Show Helpful Button",
          "default": true
        }
      ]
    }
  ],
  "presets": [
    {
      "name": "Product Reviews"
    }
  ]
}
{% endschema %}